{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ user.username }}'s Profile — Sam-movie</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #0f1115;
            color: #e6e6e6;
            padding-top: 70px;
        }

        .navbar {
            background: #1a1d24;
        }

        @media (max-width: 768px) {
            .navbar-toggler {
                margin-right: 16px;
                /* xohlasang 8–16px oralig‘ida o‘zgartir */
            }
        }

        .brand {
            font-weight: 800;
            letter-spacing: .5px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }


        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #ffc107;
        }

        .back-btn {
            color: #ffc107;
            text-decoration: none;
            font-weight: bold;
            margin-right: 15px;
        }

        .card {
            background: #1a1d24;
            border: 1px solid #262a33;
            transition: transform .2s ease, box-shadow .2s ease;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
        }

        .poster {
            aspect-ratio: 2/3;
            object-fit: cover;
            width: 100%;
            border-radius: .5rem;
        }

        .truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .meta {
            color: #9aa0a6;
            font-size: .9rem;
        }
    </style>
</head>

<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-dark fixed-top py-3">
        <div class="container d-flex align-items-center">
            <a class="navbar-brand brand ms-2" href="{% url 'films' %}"><span
                    class="text-warning">Sam</span>-movie</a>
            <!-- 3 CHIZIQLI MENU (OFFCANVAS OCHUVCHI) -->
            <button class="btn text-light me-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#secondNav"
                style="margin-left: -100px;">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a href="javascript:history.back()" class="btn btn-outline-light btn-sm">← Back</a>
        </div>



    </nav>

    <div class="offcanvas offcanvas-end bg-dark text-light" tabindex="-1" id="secondNav">

        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Menu</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>

        <div class="offcanvas-body">
            <a href="{% url 'film_add' %}" class="btn btn-warning w-100 mb-3">Add new movie</a>
            <a href="{% url 'logout' %}" class="btn btn-danger w-100 mb-3">Exit</a>
            <hr class="bg-secondary">

            <div class="mb-3 text-center">
                <label for="avatarInput" class="form-label">Change Avatar</label>
                <input class="form-control form-control-sm" type="file" id="avatarInput" accept="image/*">
                <img id="avatarPreview"
                    src="{% if user.profile.avatar %}{{ user.profile.avatar.url }}{% else %}https://via.placeholder.com/100?text=Avatar{% endif %}"
                    alt="Avatar Preview" class="rounded-circle mt-2"
                    style="width:80px; height:80px; object-fit:cover; border:2px solid #ffc107;">

                <!-- Tasdiqlash tugmasi -->
                <button id="avatarSubmit" class="btn btn-warning btn-sm mt-2 w-100">Confirmation</button>
            </div>

        </div>
    </div>


    <main class="container py-4">
        <!-- PROFIL HEAD -->
        <div class="profile-header">
            {% if user.profile.avatar %}
            <img src="{{ user.profile.avatar.url }}" alt="Avatar" class="profile-avatar">
            {% else %}
            <img src="https://via.placeholder.com/100?text=Avatar" alt="Avatar" class="profile-avatar">
            {% endif %}
            <div>
                <h2>{{ user.username }}</h2>
                <p class="text-secondary">User added movies: {{ films|length }}</p>
            </div>
        </div>

        <!-- FILMLAR -->
        {% if films %}
        <div class="row g-4">
            {% for film in films %}
            <div class="col-6 col-md-4 col-lg-3">
                <div class="card h-100 p-2">
                    <a href="{% url 'film-detail' film.id %}" class="d-block">
                        {% if film.image %}
                        <img src="{{ film.image.url }}" alt="{{ film.name }}" class="poster">
                        {% else %}
                        <img src="https://via.placeholder.com/400x600?text=No+Poster" class="poster" alt="No poster">
                        {% endif %}
                    </a>
                    <div class="card-body p-2">
                        <a href="{% url 'film-detail' film.id %}" class="stretched-link text-light">
                            <h5 class="mb-1">{{ film.name }}</h5>
                        </a>
                        <div class="meta">
                            {{ film.created_at|date:"Y" }} • {{ film.duration }}
                        </div>
                        {% if film.direct_by %}
                        <div class="meta">Director: {{ film.direct_by }}</div>
                        {% endif %}
                        {% if film.description %}
                        <p class="mt-2 truncate-2 text-secondary">{{ film.description|truncatewords:20 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5 text-secondary">
            There is no movie yet.
        </div>
        {% endif %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const avatarInput = document.getElementById('avatarInput');
        const avatarPreview = document.getElementById('avatarPreview');
        const avatarSubmit = document.getElementById('avatarSubmit');

        avatarInput.addEventListener('change', function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    avatarPreview.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        avatarSubmit.addEventListener('click', function () {
            const file = avatarInput.files[0];
            if (!file) {
                alert("Rasm tanlanmadi!");
                return;
            }

            const formData = new FormData();
            formData.append('avatar', file);

            fetch("{% url 'change_avatar' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
                .then(response => {
                    if (!response.ok) throw new Error("Server error!");
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        avatarPreview.src = data.avatar_url; // avatarni avtomatik yangilash
                        alert("Avatar changed successfully!");
                    } else {
                        alert("An error occurred.");
                    }
                })
                .catch(error => {
                    console.error(error);
                    alert("An error occurred: " + error.message);
                });
        });
    </script>


</body>

</html>